--- 
title: "现代统计图形"
subtitle: "Modern Statistical Graphics"
author: 
  - 谢益辉
  - 黄湘云
  - 赵鹏
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: ctexbook
output:
  bookdown::pdf_book:
    keep_tex: yes
    dev: "cairo_pdf"
    latex_engine: xelatex
    citation_package: natbib
    template: tex/template.tex
    pandoc_args:  --top-level-division=chapter
    toc_depth: 2
    toc_unnumbered: yes
    toc_appendix: yes
    quote_footer: ["\\begin{flushright}", "\\end{flushright}"]
bibliography:
  - bib/book.bib
  - bib/MSG-packages.bib
  - bib/Modern-Stat-Graphics.bib
biblio-style: plainnat
natbiboptions: "authoryear,square"
link-citations: yes
graphics: yes
mathspec: yes
lot: yes
lof: yes
classoption: "UTF8,twoside"
papersize: b5
colorlinks: yes
geometry:
  - tmargin=2.5cm
  - bmargin=2.5cm
  - lmargin=3.5cm
  - rmargin=2.5cm
description: "现代统计图形书稿"
subject: "统计图形, 数据可视化"
keywords: 
- R 语言
- 统计图形
- 统计学
- 图形元素
- 图形系统
- 统计图形软件
- 数据可视化
github-repo: XiangyunHuang/MSG-Book
url: 'https\://bookdown.org/xiangyun/msg/'
---

```{r, include=FALSE}
options(width = 70, bookdown.render.file_scope = FALSE, knitr.kable.NA = '', knitr.table.format = "latex")

pkgs <- c("formatR", 
          "ggplot2", "MSG", "grid", "magrittr", "ncovr", "kableExtra", "knitr", "patchwork", "RColorBrewer", "cowplot", "qqplotr")

lapply(pkgs, require,character.only = TRUE)

# convert pdf to png
to_png <- function(fig_path) {
  png_path <- sub("\\.pdf$", ".png", fig_path)
  magick::image_write(
    magick::image_read_pdf(fig_path), 
    format = "png", 
    path = png_path, 
    density = 300, 
    quality = 100)
  return(png_path)
}

# show the usage of a function
## example: usage2(usage(text.default, output = FALSE))
usage2 <- function(txt){
  cat("```r", 
      txt, 
      "```", sep = '\n')
}

table_font_size <- 8

# 这段代码必须放在其他 .Rmd （part1.Rmd） 文件里才能不出现乱码。奇怪。而且，当 caption.short 为中文时，放在 kable_styling 里就会出现乱码。
# kable3 <- function(x, x_scap, table_font_size = 8, latex_options = "basic", x_cap = ""){
#   x_head <- head(x, 5)
#   if(x_cap == "") x_cap <- paste0(x_scap, "（部分。原数据为 ", nrow(x), " 行 ", ncol(x), " 列）")
#   kableExtra::kable_styling(
#     knitr::kable(x_head, "latex",
#                  booktabs = TRUE,
#                  caption = x_cap,
#                  caption.short = x_scap,
#                  align = 'c'),
#     latex_options = latex_options,
#     font_size = table_font_size
#   )
# }

is_latex <- identical(knitr::opts_knit$get("rmarkdown.pandoc.to"), "latex")
is_html <- identical(knitr::opts_knit$get("rmarkdown.pandoc.to"), "html")


def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set()

knitr::knit_hooks$set(
  chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
},
  optipng = knitr::hook_optipng,
  pdfcrop = knitr::hook_pdfcrop,
  small.mar = function(before, options, envir) {
    if (before) {
      par(mar = c(4, 4, .1, .1), 
          cex.lab = .95, 
          cex.axis = .9, 
          mgp = c(2, .7, 0), 
          tcl = -.3) # smaller margin on top and right
      }
  },
  font.cn = function(before, options, envir) {
    if (before) pdf.options(family = "GB1")
  },
  font.en = function(before, options, envir) {
    if (before) pdf.options(family = "Times")
  }
)

knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE,
  size="small",
  fig.align = "center",
  cache = TRUE,
  small.mar = TRUE,
  fig.showtext = TRUE,
  dpi = 300
)

if (is_latex) {
  knitr::opts_chunk$set(
    out.width = "100%"
  )
}

plot_ggmap <- function(x,
                       col_name = 'confirmedCount',
                       province_language = 'chinese',
                       show_capitials = TRUE,
                       add_title = NA){
  load(system.file('ProvinceMapDatas.Rda', package = 'ncovr'))
  city_position <- readr::read_csv(
    system.file("city_position.csv", package = 'ncovr')
  )
  x$value <- x[, col_name]
  
  china_map_virus = dplyr::left_join(
    df_China, x[, c('provinceShortName', 'value')],
    by = c("NAME" = "provinceShortName")
  )
  
  p <-
    ggplot() +
    geom_polygon(
      data = china_map_virus,
      aes(x = long, y = lat, group = interaction(class, group), fill = value),
      colour = "black",
      size = 0.25
    ) +
    geom_rect(
      aes(xmin = 124, xmax = 124 + 9.3, ymin = 16 - 0.3, ymax = 16 + 9),
      fill = NA,
      colour = "black",
      size = 0.25
    ) +
    geom_line(
      data = df_NanHaiLine,
      aes(x = long, y = lat, group = ID),
      colour = "grey40",
      size = 1
    ) +
    scale_fill_gradient(
      low = "white",
      high = "darkred",
      na.value = "white",
      trans = "log",
      limits = c(1, 10^3),
      breaks = 10 ^(0:3),
      labels = c('1', '10', '100', '1,000')
    )  +
    coord_map() +
    ylim(14, 54) +
    theme(
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.background = element_blank(),
      legend.position = c(0.85, 0.4),
      legend.title = element_blank(),
      legend.background = element_blank(),
      plot.title = element_text(
        hjust = 0.5,
        size = 16,
        face = "bold",
        color = "black"
      )
    )
  
  if (!is.na(add_title)) {
    p <- p +
      geom_text(
        data = data.frame(long = 105, lat = 50),
        aes(x = long, y = lat, label = add_title),
        colour = "black",
        size = 5
      )
  }
  
  if (show_capitials){
    p <- p +
      geom_point(
        data = city_position,
        aes(x = long, y = lat),
        colour = "black",
        size = 1
      )
  }
  
  if (!is.na(province_language)){
    if (province_language == 'english') {
      dic_city <-  readr::read_csv(
        system.file('china_city_list.csv', package = 'ncovr')
      )
      city_position$province <- dic_city$Province_EN[
        match(city_position$province, dic_city$Province)
      ]
    }
    p <- p +
      geom_text(
        data = city_position,
        aes(x = long, y = lat, label = province),
        colour = "black",
        size = 3,
        vjust = 0,
        nudge_y = 0.5
      )
  }
  
  p
}
tables <- list()

Sys.setlocale("LC_CTYPE", "Chinese")
```
